name: Publish SDK

on:
  push:
    branches:
      - main
      - move
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Just
        uses: extractions/setup-just@v3

      - name: Install Aptos CLI
        run: |
          curl -fsSL "https://aptos.dev/scripts/install_cli.sh" | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Aptos CLI
        run: aptos --version

      - name: Install dependencies
        run: bun install

      - name: Start Aptos localnet
        run: |
          aptos node run-local-testnet --with-faucet --force-restart > /tmp/localnet.log 2>&1 &
          echo "⏳ Waiting for localnet to start..."
          timeout 120 bash -c 'until curl -s http://localhost:8080/v1 > /dev/null 2>&1; do sleep 2; done'
          echo "⏳ Waiting for DB to bootstrap..."
          sleep 10
          echo "✅ Localnet is ready"

      - name: Initialize Aptos CLI profile
        run: |
          for i in {1..5}; do
            echo -e "\n\n" | aptos init --network local --profile default && break
            echo "Retry $i/5..."
            sleep 5
          done

      - name: Deploy contracts to localnet
        run: just localnet-deploy

      - name: Generate SDK ABI from localnet
        run: just sdk-generate

      - name: Build SDK
        run: |
          cd sdk
          bun run build

      - name: Setup git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump version and publish
        run: |
          cd sdk

          # Get current version
          CURRENT_VERSION=$(bun -p "require('./package.json').version")

          # Extract major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Increment minor version, reset patch to 0
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"

          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION"

          # Update package.json version
          bun -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json')); pkg.version='$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2)+'\n');"

          # Commit version bump
          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

          # Publish to npm (prepublishOnly will run build automatically)
          bun publish --access public
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
